<!DOCTYPE html>
<html>
<head>
  <title>Fill Up all the details below</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <!-- Include the Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-storage.js"></script>
  <style>
    /* Existing Styles */
    label.error {
        color: red;
        background-color: #f2dede;
        border-color: #ebccd1;
        padding: 5px;
    }

    .error {
        border: 1px solid red !important;
    }

    /* New Styles */
    .travelerInfo {
        font-family: Arial, sans-serif;  /* Use your preferred font */
        color: #333;  /* Dark gray for the text */
        background-color: #f9f9f9;  /* Light gray for the background */
        padding: 20px;  /* Space inside the container */
        border-radius: 10px;  /* Rounded corners */
    }

    .travelerInfo label,
    .travelerInfo input,
    .travelerInfo select {
        display: inline-block;  /* Show fields side by side */
        width: 40%;  
        padding: 10px;
        margin: 0.5%;  /* Space between fields */
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .travelerInfo button {
        background-color: #008CBA;  /* Blue background */
        color: white;  /* White text */
        border: none;  /* No border */
        padding: 15px 32px;  /* Vertical and horizontal padding */
        text-decoration: none;
        margin: 4px 2px;
        cursor: pointer;  /* Cursor style */
        border-radius: 5px;  /* Slightly rounded corners */
    }

    .travelerInfo button:hover {
        background-color: #007B9A;  /* Darker blue on hover */
    }
</style>
</head>
<body>
  <h1>Fill Up all the details below</h1>
  
  <form id="TripForm">
    <label for="serviceType">Type of Service:</label>
    <select id="serviceType" name="serviceType" required>
      <option value="">Select service</option>
      <option value="Trek">Trek</option>
      <option value="Tour/Homestay/WFM">Tour/Homestay/WFM</option>
      <option value="CabRental">Cab Rental</option>
    </select>

    <!-- Section 1 -->
    <div id="section1">
      <h2>Section 1</h2>
      <label for="destination">Destination:</label>
      <input type="text" id="destination" name="destination" maxlength="20" required>
      
      <label for="tripStartDate">Trip Starting Date:</label>
      <input type="date" id="tripStartDate" name="tripStartDate" required>
      
      <label for="tripEndDate">Trip End Date:</label>
      <input type="date" id="tripEndDate" name="tripEndDate" required>
      
      <label for="bookingID">Booking ID:</label>
      <input type="text" id="bookingID" name="bookingID" maxlength="20" required>
      
      <label for="numberOfTravelers">No. Of Travelers:</label>
      <input type="number" id="numberOfTravelers" name="numberOfTravelers" min="1" value="1" required>

      <button type="button" id="goToSection2">Next</button>
    </div>

    <div id="section2" style="display: none;">
      <!-- Section 2 -->
      <h2>Section 2</h2>
      <!-- Your form fields here -->
      <div id="travelerInfoContainer">
        <!-- Traveler info will be added here -->
      </div>

    <input type="submit" value="Submit">
  </form>

  <script>
   $(document).ready(function() {
    const firebaseConfig = {
      apiKey: "AIzaSyDT1R0e9RHa6L9NWWV3Mk9SI6gYHIepe_0",
      authDomain: "customer-data-f1dd3.firebaseapp.com",
      projectId: "customer-data-f1dd3",
      storageBucket: "customer-data-f1dd3.appspot.com",
      messagingSenderId: "789752762056",
      appId: "1:789752762056:web:7d434ab157de5ede179ffd",
      measurementId: "G-4C2QQE2XGX"
    };
  
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);


  // Ensure that the trip end date is after the trip start date
  $('#tripStartDate').change(function() {
    var tripStartDate = $(this).val();
    $('#tripEndDate').attr('min', tripStartDate);
  });
     
  // Update form fields when service type changes
  $('#serviceType').change(function() {
    if ($(this).val() === 'CabRental') {
      $('.foodChoice').hide();
      $('.foodAllergy').hide();
      $('.declarationFile').hide();
    } else {
      $('.foodChoice').show();
      $('.foodAllergy').show();
      if ($(this).val() === 'Trek') {
        $('.declarationFile').show();
      } else {
        $('.declarationFile').hide();
      }
    }
  });

  $('#goToSection2').click(function() {
    if($('#TripForm').valid()){
      $('#section1').hide();
      $('#section2').show();
    }
  });

  // Update traveler info fields when number of travelers changes
  $('#numberOfTravelers').change(function() {
    var numberOfTravelers = $(this).val();

    // Clear the traveler info container
    $('#travelerInfoContainer').empty();

    // Add the traveler info fields for each traveler
    for (var i = 0; i < numberOfTravelers; i++) {
      $('#travelerInfoContainer').append(`
        <div class="travelerInfo">
          <h3>Traveler ${i + 1}</h3>

          <label for="travelerName${i}">Your Name:</label>
          <input type="text" id="travelerName${i}" name="travelerName${i}" maxlength="20" required>

          <label for="dob${i}">DOB:</label>
          <input type="date" id="dob${i}" name="dob${i}" required>

          <label for="gender${i}">Gender:</label>
          <select id="gender${i}" name="gender${i}" required>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>

          <label for="email${i}">Email:</label>
          <input type="email" id="email${i}" name="email${i}" maxlength="20" required>

          <label for="phone${i}">Phone Number:</label>
          <input type="tel" id="phone${i}" name="phone${i}" required>

          <label for="idProof${i}">Voter/Aadhar Id proof (Max 10mb):</label>
          <input type="file" id="idProof${i}" name="idProof${i}" required>

          <label for="emergencyContactName${i}">Emergency Contact Name:</label>
          <input type="text" id="emergencyContactName${i}" name="emergencyContactName${i}" maxlength="30" required>

          <label for="emergencyContactNumber${i}">Emergency Contact Number:</label>
          <input type="tel" id="emergencyContactNumber${i}" name="emergencyContactNumber${i}" required>

          <label class="foodChoice" for="foodChoice${i}">What Food do you want to choose?</label>
          <select class="foodChoice" id="foodChoice${i}" name="foodChoice${i}" required>
            <option value="Veg">Veg</option>
            <option value="Nonveg">Nonveg</option>
            <option value="Only Egg">Only Egg</option>
            <option value="NA">N/A</option>
          </select>

          <label class="foodAllergy" for="foodAllergy${i}">Do you have any type of food allergies?</label>
          <select class="foodAllergy" id="foodAllergy${i}" name="foodAllergy${i}" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="NA">N/A</option>
          </select>

          <label for="covidSymptoms${i}">Any type of Covid-19 Symptoms?</label>
          <select id="covidSymptoms${i}" name="covidSymptoms${i}" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>

          <label for="covidAffected${i}">Have you been affected with Covid-19 within the last 90 days?</label>
          <select id="covidAffected${i}" name="covidAffected${i}" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>

          <label for="vaccineDose${i}">Have you taken any dose of Covid-19 Vaccine?</label>
          <select id="vaccineDose${i}" name="vaccineDose${i}" required>
            <option value="No">No</option>
            <option value="Dose1">Dose 1</option>
            <option value="Both Dose">Both Dose</option>
          </select>

          <label for="vaccineCertificate${i}">If yes, upload your vaccination certificate (Max 10mb):</label>
          <input type="file" id="vaccineCertificate${i}" name="vaccineCertificate${i}" required>

          <label class="declarationFile" for="declarationFile${i}">Declaration Document (Max 10mb):</label>
          <input class="declarationFile" type="file" id="declarationFile${i}" name="declarationFile${i}" required>
        </div>
      `);
    }

    
    // Re-initialize the jQuery Validate plugin
    $('#TripForm').validate();
  });
// Trigger the change event manually
$('#numberOfTravelers').change();
// AJAX function to submit the form
    $('#TripForm').submit(function(e) {
      e.preventDefault();
      
  // Get the form data
  var data = $(this).serializeArray();

  // Convert the form data to an object
  var formData = {};
  data.forEach(function(item) {
    formData[item.name] = item.value;
  });

  // Get the traveler data
  var travelerData = [];
  var numberOfTravelers = formData['numberOfTravelers'];
  for (var i = 0; i < numberOfTravelers; i++) {
    var traveler = {};
    traveler['travelerName'] = formData['travelerName' + i];
    // Add all other traveler fields...

          // Handle file uploads for each traveler
      var idProofFile = document.getElementById('idProof' + i).files[0];
      var vaccineCertFile = document.getElementById('vaccineCertificate' + i).files[0];
      var declarationFile = document.getElementById('declarationFile' + i).files[0];

      var maxSizeInBytes = 10 * 1024 * 1024; // 10MB in bytes
      // Check if the ID proof file size is less than 10MB
      if(idProofFile.size > maxSizeInBytes) {
        alert('The ID proof file for traveler ' + (i+1) + ' is too large. Please upload a file less than 10MB.');
        return;
      }

      // Check if the vaccine certificate file size is less than 10MB
      if(vaccineCertFile.size > maxSizeInBytes) {
        alert('The vaccine certificate file for traveler ' + (i+1) + ' is too large. Please upload a file less than 10MB.');
        return;
      }

      if(declarationFile.size > maxSizeInBytes) {
        alert('The Declaration file for traveler ' + (i+1) + ' is too large. Please upload a file less than 10MB.');
        return;
      }
    
      var storageRef = firebase.storage().ref();
      var idProofRef = storageRef.child('idProofs/' + formData['bookingID'] + '/traveler' + i);
      var vaccineCertRef = storageRef.child('vaccineCertificates/' + formData['bookingID'] + '/traveler' + i);
      var declarationRef = storageRef.child('declarationDocuments/' + formData['bookingID'] + '/traveler' + i);
      
      idProofRef.put(idProofFile).then((snapshot) => {
        console.log('Uploaded ID proof for traveler ' + i);
      });

      vaccineCertRef.put(vaccineCertFile).then((snapshot) => {
        console.log('Uploaded vaccine certificate for traveler ' + i);
      });

      declarationRef.put(declarationFile).then((snapshot) => {
        console.log('Uploaded declaration document for traveler ' + i);
      });

    travelerData.push(traveler);
  }

  // Remove the individual traveler fields from the form data
  Object.keys(formData).forEach(function(key) {
    if (key.startsWith('traveler')) {
      delete formData[key];
    }
  });

  // Add the traveler data to the form data
  formData['travelers'] = travelerData;


  // Validate form data...
      if (!$(this).valid()) {
        return;
      }     
  // Adding document to Firestore
  db.collection("forms").add({
    formData: formData
  })
  .then((docRef) => {
    console.log("Document written with ID: ", docRef.id);
    // Hide the form after successful submission
    $('#TripForm').hide();

    // Show a success message
    $('body').append('<p>Your form has been successfully submitted!</p>');
  })
  .catch((error) => {
    console.error("Error adding document: ", error);
    alert('There was an error booking your trip. Please try again.');
  });
});
     // Initialize the jQuery Validate plugin
      $('#TripForm').validate();
  });
</script>
</body>
</html>
